# Waveshare ESP32-S3-RLCD-4.2 天气站

基于 Waveshare ESP32-S3-RLCD-4.2 开发板的智能天气站，集成 AI 助手、备忘录、温湿度传感器等功能。

---

## 硬件特性

### 主控芯片
- **ESP32-S3-WROOM-1-N16R8**
  - 双核 Xtensa LX7 @ 240MHz
  - 16MB Flash + 8MB PSRAM
  - WiFi 802.11 b/g/n + Bluetooth 5.0 LE

### 显示屏
- **400×300 RLCD（反射式液晶显示器）**
  - 1-bit 单色显示（黑/白）
  - 超低功耗（静态显示几乎不耗电）
  - 阳光下可读
  - 接口：SPI

### 传感器
- **SHTC3** - 温湿度传感器
  - 温度精度：±0.2°C
  - 湿度精度：±2% RH
  - 接口：I2C

- **PCF85063** - 实时时钟（RTC）
  - 内置纽扣电池备份
  - 断电后保持时间
  - 接口：I2C

### 音频
- **ES8311** - 音频解码器（喇叭输出）
- **ES7210** - 音频编码器（麦克风输入）
- **MAX98357A** - D 类功放

### 电源
- **锂电池接口** + **USB-C 充电**
- **ADC 电量检测**（GPIO4）

### 按键
- **BOOT 按钮**（GPIO0）
- **USER 按钮**（GPIO18）

---

## 按键功能

### 🔵 BOOT 按钮（GPIO0）- 主要交互

| 操作 | 功能 | 说明 |
|---|---|---|
| **单击** | 唤醒/停止 AI 对话 | 开始语音识别或停止 AI 回复 |
| **单击**（启动时） | 进入配网模式 | 首次使用时配置 WiFi |

### 🟢 USER 按钮（GPIO18）- 辅助功能

| 操作 | 功能 | 说明 |
|---|---|---|
| **单击** | 切换屏幕模式 | 循环切换显示布局（功能开发中）|
| **双击** | 刷新所有数据 | 手动更新天气、NTP 时间、传感器数据 |
| **长按 2 秒** | 显示系统信息 | 在 AI 对话区循环滚动显示：<br>• CPU 频率 (240MHz)<br>• 运行时间<br>• SRAM 使用情况（已用/总量 百分比）<br>• PSRAM 使用情况（已用/总量 百分比）<br>• 电池电量和充电状态<br>• WiFi 连接状态<br>**注：** 长文本会自动循环滚动（2秒一屏），AI 对话时恢复正常换行 |

---

## 屏幕布局

```
┌────────────────────────────────────────────┐
│ 🌡 24.5°C 60%        [WiFi] [🔋 85%]      │  ← 状态栏
├──────────────────┬─────────────────────────┤
│                  │        TUE             │
│      14:30       │        ──              │  ← 时钟 + 日历
│                  │        15              │
│                  │     晴 ☀ 25°C          │
├──────────────────┼─────────────────────────┤
│  😊              │       MEMO             │
│  开心     正在聆听… │    ─────────────────  │  ← AI 助手 + 备忘录
│                  │  · 15:00 开会          │
│                  │  · 买牛奶              │
└──────────────────┴─────────────────────────┘
```

### 布局说明

#### 左上：时钟卡片（248×128px）
- 大字显示当前时间（HH:MM）
- 自动从 NTP 服务器同步
- 断电后从 RTC 芯片恢复

#### 右上：日历 + 天气（130×128px）
- 星期缩写（英文）
- 日期数字
- 天气状况 + 温度（来自和风天气 API）

#### 左下：AI 对话区（252×122px）
- 左侧：表情图标 + 状态文字
- 右侧：AI 对话内容（最新一条）
- 支持小智 21 种表情显示

#### 右下：备忘录（126×122px）
- 显示最近 5 条待办事项
- 格式：`时间 内容` 或 `· 内容`
- 超过 5 条时显示"...还有 X 条"

---

## AI 工具（MCP Tools）

设备暴露以下工具给 AI 助手：

### 系统工具

#### `self.disp.network`
**功能：** 重新进入配网模式  
**用法：** 用户说"重新配网"、"换个 WiFi"

---

### 备忘录工具

#### `self.memo.add`
**功能：** 添加备忘/提醒/待办  
**参数：**
- `content` (string) - 备忘内容（建议 ≤8 个中文字，适配小屏幕）
- `time` (string, 可选) - 时间标签，支持：
  - `"15:00"` - 定时提醒（到点后自动弹窗并删除）
  - `"明天"`、`"周五"` - 自然语言（仅作标记，不会触发提醒）
  - `""` - 空字符串，无时间标记

**示例：**
- 用户："提醒我下午 3 点开会" → `self.memo.add(content="开会", time="15:00")`
- 用户："记住买牛奶" → `self.memo.add(content="买牛奶", time="")`

**限制：** 最多 10 条备忘

#### `self.memo.list`
**功能：** 查看所有备忘  
**返回：** 带序号的备忘列表

#### `self.memo.done`
**功能：** 完成/删除某条备忘  
**参数：**
- `index` (int, 1-10) - 备忘序号（从 1 开始）

**示例：**
- 用户："第一条做完了" → `self.memo.done(index=1)`

#### `self.memo.clear`
**功能：** 清空所有备忘  
**用法：** 用户说"清空备忘"、"全部删掉"

---

## 系统信息查询

### MCP 工具

#### `self.system.info`
**功能：** 获取设备系统信息（CPU、内存、电池、WiFi 状态）  
**触发方式：**
- 用户语音："系统信息"、"CPU频率"、"内存使用情况"、"电量多少"
- AI 会调用工具获取数据，然后**语音播报**

**返回内容：**
- CPU 频率 (240MHz)
- 运行时间
- SRAM 使用情况（已用/总量/百分比）
- PSRAM 使用情况（已用/总量/百分比）
- 电池电量和充电状态
- WiFi 连接状态

**使用示例：**
```
用户："小智，看看系统信息"
AI：  调用 self.system.info 获取数据
     "系统运行正常，CPU频率240MHz，已运行5小时30分钟。
      内存方面，SRAM使用了156KB，占总量512KB的30%；
      PSRAM使用了2MB，占总量8MB的25%。
      电池电量85%，当前正在充电。WiFi已连接。"
```

**与按键的区别：**
| 方式 | 长按 USER 键 | 语音询问 |
|---|---|---|
| 显示 | ✅ 循环滚动显示 | ✅ AI 对话区正常显示 |
| 播报 | ❌ 无语音 | ✅ AI 语音读出 |
| 适用场景 | 快速查看 | 详细了解 |

---

## 数据存储

### NVS（非易失性存储）

| Namespace | Key | 数据类型 | 说明 |
|---|---|---|---|
| `wifi` | `ssid`, `password` | String | WiFi 凭据（由 BluFi/Hotspot 配网写入）|
| `memo` | `items` | JSON Array | 备忘录列表 |

**备忘录 JSON 格式：**
```json
[
  {"t": "15:00", "c": "开会"},
  {"t": "", "c": "买牛奶"}
]
```

---

## 传感器数据

### 温湿度（SHTC3）
- **更新频率：** 每秒检测变化
- **显示阈值：**
  - 温度变化 > 0.2°C 时更新
  - 湿度变化 > 1% 时更新
- **位置：** 左上角状态栏

### RTC 时钟（PCF85063）
- **功能：** 断电后保持时间
- **同步方式：**
  1. 首次联网后，NTP 同步 → 写入 RTC
  2. 每 24 小时自动 NTP 校准一次
  3. 检测到系统时间被篡改时，从 RTC 恢复

---

## 电池管理

### 电量检测
- **ADC 通道：** GPIO4（ADC1_CH3）
- **分压比：** 3:1
- **滤波算法：**
  - 采样 10 次取平均（减少噪声）
  - EMA 指数移动平均（alpha=0.1，消除漂移）
  - 抛物线拟合（电压 → 百分比）

### 电量映射
```
4200mV → 100%
3700mV →  50%
3300mV →   0%
```

---

## 网络配置

### WiFi 配网方式

#### 方式 1：BluFi（蓝牙配网）✅ 推荐
1. 设备首次启动或长按 BOOT 进入配网模式
2. 手机打开 **EspBlufi App**（[iOS](https://apps.apple.com/app/espblufi/id1450985126) / [Android](https://github.com/EspressifApp/EspBlufiForAndroid/releases)）
3. 搜索设备名称：`Xiaozhi-Blufi`（IDF 5.5.2）或 `BLUFI_DEVICE`（IDF 5.5.1）
4. 输入 WiFi SSID 和密码
5. 等待连接成功

**优点：**
- 无需临时切换 WiFi
- 支持获取设备扫描的 WiFi 列表
- 可选加密通信

#### 方式 2：热点配网（Hotspot）
1. 设备启动后自动开启热点：`Xiaozhi-XXXX`
2. 手机连接该热点
3. 浏览器访问：`http://192.168.4.1`
4. 网页上输入 WiFi 信息

**优点：**
- 无需安装 App
- 跨平台兼容性好

**注意：** BluFi 和热点配网不能同时启用，在 `idf.py menuconfig` 中选择一种。

---

## 天气数据

### 和风天气 API
- **更新频率：** 每 10 分钟（仅在空闲状态）
- **API 文档：** https://dev.qweather.com/
- **流量消耗：** ~5KB / 次，~720KB / 天

### 配置方式
1. 复制 `secret_config.h.example` → `secret_config.h`
2. 填入你的 API Key：
   ```cpp
   #define WEATHER_API_KEY "your_key_here"
   #define WEATHER_API_HOST "devapi.qweather.com"
   ```
3. 重新编译固件

### 显示内容
- 城市名称
- 天气状况（晴、多云、雨等）
- 实时温度

---

## 编译和烧录

### 环境要求
- **ESP-IDF：** v5.5.1 或 v5.5.2
- **Python：** 3.8+

### 步骤
```bash
# 1. 克隆仓库
git clone <your-repo-url>
cd xiaozhi-esp32

# 2. 配置（首次）
idf.py menuconfig
# → WiFi Configuration Method 选择 Esp Blufi 或 Hotspot

# 3. 编译
idf.py build

# 4. 烧录 + 监控串口
idf.py flash monitor
```

### 常用命令
```bash
# 仅烧录（不重新编译）
idf.py flash

# 清除 NVS（重置所有设置）
idf.py erase-flash

# 监控串口输出
idf.py monitor
```

---

## 功耗分析

### 典型功耗
| 状态 | 电流 | 说明 |
|---|---|---|
| 空闲（WiFi 连接） | ~80-120mA | 屏幕每秒刷新一次 |
| AI 对话（录音） | ~150-200mA | 麦克风 + WiFi 数据传输 |
| AI 对话（播放） | ~180-250mA | 功放 + 喇叭 |
| 深度睡眠 | ~5mA | 未实现（计划中）|

### 续航估算
假设 1000mAh 锂电池：
- 空闲待机：~8-12 小时
- 频繁对话：~4-6 小时

**优化建议：**
- 实现自动休眠功能（5 分钟无操作降低刷新率）
- 空闲时关闭 WiFi（保持 RTC 时钟）

---

## 故障排查

### 屏幕不显示
1. 检查 SPI 引脚连接：
   - MOSI → GPIO12
   - SCK → GPIO11
   - CS → GPIO40
   - DC → GPIO5
   - RST → GPIO41
2. 查看串口日志：`初始化 RLCD 屏幕` 是否成功
3. 检查电源供应是否稳定

### WiFi 连接失败
1. 检查 SSID 和密码是否正确
2. 路由器是否支持 2.4GHz（ESP32 不支持 5GHz）
3. 清除 NVS：`idf.py erase-flash`，重新配网

### 时间不准
1. 确认已联网（WiFi 图标显示）
2. 手动刷新：长按 USER 按钮
3. 检查时区设置：`config.h` 中 `TIMEZONE_STRING`

### 天气不更新
1. 检查 `secret_config.h` 中的 API Key 是否有效
2. 查看串口日志：是否有 HTTP 请求错误
3. 确认 API 免费额度未用完

### 备忘提醒不触发
1. 确认时间格式为 `HH:MM`（如 `15:00`）
2. 确认系统时间正确（NTP 已同步）
3. 查看串口日志：是否有"触发备忘闹钟"日志

### 按键无反应
1. 检查按键引脚：
   - BOOT → GPIO0
   - USER → GPIO18
2. 查看串口日志：是否有按键事件
3. 尝试其他操作（单击/双击/长按）

---

## 开发计划

详见 [`docs/2026-02-10-计划文档.md`](../../../docs/2026-02-10-计划文档.md)

### 近期计划
- [ ] 电源管理优化（自动休眠）
- [ ] 备忘录增强（日期提醒、重复提醒）
- [ ] 传感器历史数据记录
- [ ] 多屏幕模式切换
- [ ] 番茄钟功能

---

## 技术支持

### 相关文档
- [小智 ESP32 原项目](https://github.com/78/xiaozhi-esp32)
- [Waveshare 官方 Wiki](https://www.waveshare.com/wiki/ESP32-S3-RLCD-4.2)
- [ESP-IDF 编程指南](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/)

### 开发板购买
- [微雪电子官方商城](https://www.waveshare.net/)
- [淘宝店铺](https://waveshare.taobao.com/)

---

## 许可证

本项目基于小智 ESP32 项目开发，遵循原项目许可证。

---

**最后更新：** 2026-02-10
