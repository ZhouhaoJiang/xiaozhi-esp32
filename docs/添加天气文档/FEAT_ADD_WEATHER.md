# feat/add-weather åˆ†æ”¯è¯´æ˜

## ç›®æ ‡

å°† [MyWeatherStation](../../MyWeatherStation) é¡¹ç›®çš„å¤©æ°”ç«™ UI ç§»æ¤åˆ° [xiaozhi-esp32](https://github.com/78/xiaozhi-esp32) é¡¹ç›®ä¸­ï¼Œå®ç° **å¤©æ°”ç«™ + AI åŠ©æ‰‹** çš„èåˆæ–¹æ¡ˆã€‚

åœ¨ Waveshare ESP32-S3-RLCD-4.2 è¿™å— 400x300 çš„ 1-bit åå°„å¼ LCD ä¸Šï¼Œå®ç°ä»¥ä¸‹ 2x2 å¡ç‰‡å¸ƒå±€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  â”‚                  â”‚
â”‚   æ—¶é’Ÿå¡ç‰‡        â”‚    æ—¥å†å¡ç‰‡       â”‚
â”‚  (æ—¶é—´/æ—¥æœŸ)      â”‚  (æœˆå†/å†œå†)      â”‚
â”‚                  â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                  â”‚
â”‚   AI å¯¹è¯åŒºåŸŸ     â”‚    å¤©æ°”/ä¼ æ„Ÿå™¨     â”‚
â”‚  (å°æ™ºæ¥ç®¡è¿™é‡Œ)   â”‚  (æ¸©æ¹¿åº¦/å¤©æ°”)    â”‚
â”‚                  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **å·¦ä¸‹è§’ AI åŒºåŸŸ**ï¼ˆçº¦ 200x150 åƒç´ ï¼‰ï¼šç”±å°æ™ºçš„ `Display` æŠ½è±¡å±‚é©±åŠ¨ï¼Œæ˜¾ç¤ºå¯¹è¯çŠ¶æ€ã€èŠå¤©æ–‡å­—ã€è¡¨æƒ…ç­‰
- **å…¶ä½™ä¸‰ä¸ªå¡ç‰‡**ï¼šä¿ç•™ MyWeatherStation çš„å¤©æ°”ç«™ UI

## ç¡¬ä»¶ä¿¡æ¯

| å‚æ•° | å€¼ |
|---|---|
| èŠ¯ç‰‡ | ESP32-S3 (å¸¦ PSRAM) |
| å±å¹• | 4.2 è‹±å¯¸åå°„å¼ LCDï¼Œ400x300ï¼Œ1-bit é»‘ç™½ |
| å±å¹•æ¥å£ | SPI |
| éŸ³é¢‘ | ES8311 (æ’­æ”¾) + ES7210 (å½•éŸ³)ï¼ŒI2S æ¥å£ |
| ä¼ æ„Ÿå™¨ | SHTC3 (æ¸©æ¹¿åº¦)ï¼ŒPCF85063 (RTC æ—¶é’Ÿ) |
| ç”µæ±  | ADC æ£€æµ‹ç”µå‹ï¼Œé€šè¿‡ ADC_CHANNEL_3 |
| æŒ‰é’® | BOOT é”® (GPIO 0) |

## å½“å‰è¿›åº¦

### âœ… å·²å®Œæˆ

1. **æ–°æ¿å­æ³¨å†Œ**
   - `main/Kconfig.projbuild` â€” æ·»åŠ  `CONFIG_BOARD_TYPE_WAVESHARE_S3_RLCD_4_2` é€‰é¡¹
   - `main/CMakeLists.txt` â€” æ·»åŠ æ¿å­ç±»å‹æ˜ å°„å’Œç¼–è¯‘è§„åˆ™

2. **åŸºç¡€æ¿å­å®ç°** (`main/boards/waveshare-s3-rlcd-4.2/`)
   - `config.h` â€” GPIO å¼•è„šå®šä¹‰ã€RLCD å°ºå¯¸ã€I2C/SPI/éŸ³é¢‘é…ç½®
   - `config.json` â€” ç¼–è¯‘é…ç½®å…ƒæ•°æ®
   - `waveshare-s3-rlcd-4.2.cc` â€” æ¿å­ä¸»å®ç°ï¼Œç»§æ‰¿ `WifiBoard`ï¼Œé›†æˆ I2Cã€æŒ‰é’®ã€éŸ³é¢‘ã€ç”µæ± æ£€æµ‹
   - `custom_lcd_display.h / .cc` â€” RLCD æ˜¾ç¤ºé©±åŠ¨ï¼Œç»§æ‰¿ `LcdDisplay`
     - SPI é€šä¿¡åˆå§‹åŒ–
     - RLCD ç¡¬ä»¶é‡ç½®å’Œå‘½ä»¤åºåˆ—
     - RGB565 â†’ 1-bit é»‘ç™½è½¬æ¢ï¼ˆLVGL flush å›è°ƒä¸­å®ç°ï¼‰
     - åƒç´ æŸ¥æ‰¾è¡¨ (LUT) ä¼˜åŒ–ï¼Œæ”¯æŒæ¨ªå±/ç«–å±ä¸¤ç§æ¨¡å¼
   - `README.md` â€” ç¼–è¯‘è¯´æ˜

3. **ESP-IDF 5.5.2 å¼€å‘ç¯å¢ƒ**
   - æ‰‹åŠ¨å®‰è£… xtensa-esp-elf å·¥å…·é“¾ (`esp-14.2.0_20251107`)
   - æ‰‹åŠ¨å®‰è£… riscv32-esp-elf å·¥å…·é“¾
   - Python è™šæ‹Ÿç¯å¢ƒå’Œæ‰€æœ‰ä¾èµ–åŒ…

### ğŸ”² å¾…å®Œæˆ

4. **ç¼–è¯‘éªŒè¯** â€” ç¡®ä¿åŸºç¡€æ¿å­ä»£ç èƒ½ç¼–è¯‘é€šè¿‡

5. **å¤©æ°”ç«™ UI ç§»æ¤** â€” ä» MyWeatherStation ç§»æ¤ä»¥ä¸‹æ¨¡å—ï¼š
   - [ ] `display_manager` â€” 2x2 å¡ç‰‡å¸ƒå±€ç®¡ç†
   - [ ] `weather_manager` â€” å’Œé£å¤©æ°” API é›†æˆï¼ˆIP å®šä½ + å¤©æ°”æŸ¥è¯¢ + GZIP è§£å‹ï¼‰
   - [ ] `sensor_manager` â€” SHTC3 æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ + PCF85063 RTC + NTP æ ¡æ—¶
   - [ ] `power_manager` â€” ç”µæ± ç›‘æ§ + ä½ç”µé‡è­¦å‘Š
   - [ ] å­—ä½“èµ„æº â€” é˜¿é‡Œå·´å·´æ™®æƒ ä½“ (16/24/48px) + é»‘ä½“ (64px)
   - [ ] å›¾æ ‡èµ„æº â€” WiFi ä¿¡å·ã€ç”µæ± çŠ¶æ€å›¾æ ‡

6. **AI åŒºåŸŸé€‚é…** â€” è®©å°æ™ºçš„ Display æŠ½è±¡å±‚åªé©±åŠ¨å·¦ä¸‹è§’åŒºåŸŸï¼š
   - [ ] é‡å†™ `SetupUI()` æ–¹æ³•ï¼Œå°† `chat_message_label_` ç­‰ UI å…ƒç´ é™åˆ¶åœ¨å·¦ä¸‹è§’å¡ç‰‡å†…
   - [ ] å¤„ç†è¡¨æƒ…/çŠ¶æ€å›¾æ ‡åœ¨å°åŒºåŸŸå†…çš„æ˜¾ç¤ºï¼ˆå¯èƒ½éœ€è¦ç¼©æ”¾æˆ–ç®€åŒ–ï¼‰
   - [ ] ç¡®ä¿å°æ™ºçš„çŠ¶æ€æ–‡å­—ï¼ˆ"æ­£åœ¨è†å¬..."ã€"æ­£åœ¨æ€è€ƒ..."ï¼‰æ­£ç¡®æ˜¾ç¤º

7. **æ•°æ®æ›´æ–°ä»»åŠ¡** â€” é›†æˆ FreeRTOS å®šæ—¶ä»»åŠ¡ï¼š
   - [ ] å¤©æ°”åŒæ­¥ä»»åŠ¡ï¼ˆæ¯ 30 åˆ†é’Ÿï¼‰
   - [ ] UI åˆ·æ–°ä»»åŠ¡ï¼ˆæ¯åˆ†é’Ÿæ›´æ–°æ—¶é’Ÿï¼‰
   - [ ] ä¼ æ„Ÿå™¨è¯»å–ä»»åŠ¡

## æ¶æ„è®¾è®¡

```
CustomBoard (WifiBoard)
  â”œâ”€â”€ BoxAudioCodec         # éŸ³é¢‘ç¼–è§£ç 
  â”œâ”€â”€ CustomLcdDisplay      # RLCD æ˜¾ç¤ºé©±åŠ¨
  â”‚     â”œâ”€â”€ LcdDisplay      # å°æ™ºçš„ LCD æŠ½è±¡ï¼ˆAI åŒºåŸŸï¼‰
  â”‚     â””â”€â”€ 2x2 å¡ç‰‡ UI    # å¤©æ°”ç«™ UIï¼ˆå¾…å®ç°ï¼‰
  â”œâ”€â”€ WeatherManager        # å¤©æ°”æ•°æ®è·å–ï¼ˆå¾…ç§»æ¤ï¼‰
  â”œâ”€â”€ SensorManager         # ä¼ æ„Ÿå™¨ç®¡ç†ï¼ˆå¾…ç§»æ¤ï¼‰
  â””â”€â”€ Button                # æŒ‰é”®å¤„ç†
```

**å…³é”®è®¾è®¡å†³ç­–ï¼š**

- `CustomLcdDisplay` ç»§æ‰¿è‡ªå°æ™ºçš„ `LcdDisplay`ï¼Œä¿ç•™ AI å¯¹è¯åŠŸèƒ½
- RLCD æ˜¯ 1-bit å±å¹•ï¼Œæ‰€æœ‰é¢œè‰²åœ¨ LVGL flush å›è°ƒä¸­è½¬æ¢ï¼š`RGB565 > 0x7FFF` ä¸ºç™½è‰²ï¼Œå¦åˆ™ä¸ºé»‘è‰²
- åƒç´ æ’åˆ—ä½¿ç”¨é¢„è®¡ç®—çš„ LUT æŸ¥æ‰¾è¡¨ï¼Œé¿å…æ¯æ¬¡åˆ·æ–°æ—¶é‡å¤è®¡ç®—
- å¤©æ°”ç«™ UI ä½¿ç”¨ LVGL åŸç”Ÿæ§ä»¶ï¼Œä¸å°æ™ºçš„ UI å…±äº«åŒä¸€ä¸ª LVGL å®ä¾‹

## ç¼–è¯‘æ–¹æ³•

### å‰ææ¡ä»¶

- **ESP-IDF v5.5.2**ï¼šxiaozhi-esp32 é¡¹ç›®è¦æ±‚çš„ ESP-IDF ç‰ˆæœ¬
- **macOS / Linux**ï¼šæ¨èå¼€å‘ç¯å¢ƒ

### ç¬¬ä¸€æ­¥ï¼šå®‰è£… ESP-IDF 5.5.2

å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… ESP-IDF 5.5.2ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

```bash
# å…‹éš† ESP-IDF v5.5.2ï¼ˆå¤§çº¦ 1GBï¼Œéœ€è¦ä¸€äº›æ—¶é—´ï¼‰
git clone -b v5.5.2 --depth 1 --recursive --shallow-submodules https://github.com/espressif/esp-idf.git ~/.espressif/v5.5.2/esp-idf

# å®‰è£… ESP32-S3 æ‰€éœ€çš„å·¥å…·é“¾å’Œ Python ä¾èµ–
# å›½å†…ç”¨æˆ·å»ºè®®è®¾ç½®é•œåƒåŠ é€Ÿï¼šexport IDF_GITHUB_ASSETS="dl.espressif.cn/github_assets"
cd ~/.espressif/v5.5.2/esp-idf
./install.sh esp32s3
```

> **ç½‘ç»œé—®é¢˜æç¤º**ï¼šå¦‚æœ GitHub ä¸‹è½½ç¼“æ…¢ï¼Œå¯ä»¥è®¾ç½® Git é•œåƒåŠ é€Ÿï¼š
> ```bash
> git config --global url."https://ghfast.top/https://github.com/".insteadOf "https://github.com/"
> ```
> ç”¨å®Œåå–æ¶ˆï¼š`git config --global --unset url."https://ghfast.top/https://github.com/".insteadOf`

### ç¬¬äºŒæ­¥ï¼šæ¿€æ´» ESP-IDF ç¯å¢ƒ

**æ¯æ¬¡æ‰“å¼€æ–°ç»ˆç«¯éƒ½éœ€è¦æ‰§è¡Œè¿™ä¸€æ­¥**ï¼Œå®ƒä¼šæŠŠç¼–è¯‘å™¨ã€Python è™šæ‹Ÿç¯å¢ƒç­‰å·¥å…·åŠ å…¥åˆ°å½“å‰ç»ˆç«¯çš„ PATH ä¸­ï¼š

```bash
. ~/.espressif/v5.5.2/esp-idf/export.sh
```

æˆåŠŸåä¼šçœ‹åˆ° `Done! You can now compile ESP-IDF projects.` çš„æç¤ºã€‚

å¯ä»¥éªŒè¯ä¸€ä¸‹ï¼š

```bash
idf.py --version
# åº”è¾“å‡ºï¼šESP-IDF v5.5.2
```

### ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®ç›®æ ‡èŠ¯ç‰‡

```bash
cd xiaozhi-esp32
idf.py set-target esp32s3
```

è¿™ä¸€æ­¥å‘Šè¯‰ç¼–è¯‘ç³»ç»Ÿæˆ‘ä»¬çš„èŠ¯ç‰‡æ˜¯ ESP32-S3ï¼ˆè€Œä¸æ˜¯ ESP32 æˆ– ESP32-C3 ç­‰å…¶ä»–å‹å·ï¼‰ã€‚

### ç¬¬å››æ­¥ï¼šé€‰æ‹©æ¿å­ç±»å‹ï¼ˆmenuconfigï¼‰

```bash
idf.py menuconfig
```

è¿™ä¼šæ‰“å¼€ä¸€ä¸ªç»ˆç«¯èœå•ç•Œé¢ï¼ˆç±»ä¼¼äº Linux å†…æ ¸é…ç½®çš„é‚£ç§ï¼‰ï¼Œå› ä¸º xiaozhi-esp32 æ”¯æŒå‡ åç§ä¸åŒçš„å¼€å‘æ¿ï¼Œæ¯å—æ¿å­çš„å±å¹•ã€éŸ³é¢‘èŠ¯ç‰‡ã€å¼•è„šå®šä¹‰éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥éœ€è¦åœ¨ç¼–è¯‘å‰å‘Šè¯‰å®ƒ"æˆ‘è¦ç”¨å“ªå—æ¿å­"ã€‚

**æ“ä½œæ­¥éª¤ï¼š**

1. ç”¨ **â†‘â†“æ–¹å‘é”®** ç§»åŠ¨åˆ° `Xiaozhi Assistant` â†’ æŒ‰ **Enter** è¿›å…¥
2. æ‰¾åˆ° `Board Type` â†’ æŒ‰ **Enter** è¿›å…¥
3. ç”¨æ–¹å‘é”®æ‰¾åˆ° `Waveshare ESP32-S3-RLCD-4.2` â†’ æŒ‰ **ç©ºæ ¼é”®** é€‰ä¸­ï¼ˆå‰é¢ä¼šå‡ºç° `(X)` æ ‡è®°ï¼‰
4. æŒ‰ **ESC** é€€å›ä¸Šä¸€å±‚ï¼Œè¿ç»­æŒ‰ **ESC** ç›´åˆ°æç¤ºæ˜¯å¦ä¿å­˜
5. é€‰æ‹© **Yes** ä¿å­˜é€€å‡º

> **è¯´æ˜**ï¼šé€‰å¥½ä¹‹åé…ç½®ä¼šä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ `sdkconfig` æ–‡ä»¶ä¸­ï¼Œä¸‹æ¬¡ç¼–è¯‘ä¸éœ€è¦å†é€‰äº†ã€‚
> å¦‚æœä½ åªæ˜¯æƒ³ç¼–è¯‘è€Œä¸æ”¹é…ç½®ï¼Œç›´æ¥è·³è¿‡è¿™æ­¥å³å¯ã€‚

### ç¬¬äº”æ­¥ï¼šç¼–è¯‘

```bash
idf.py build
```

é¦–æ¬¡ç¼–è¯‘å¤§çº¦éœ€è¦ 5-10 åˆ†é’Ÿï¼Œåç»­å¢é‡ç¼–è¯‘ä¼šå¿«å¾ˆå¤šã€‚

### ç¬¬å…­æ­¥ï¼šçƒ§å½•å’Œè°ƒè¯•

```bash
# çƒ§å½•å›ºä»¶åˆ°å¼€å‘æ¿ï¼ˆéœ€è¦ç”¨ USB æ•°æ®çº¿è¿æ¥ï¼‰
idf.py flash

# çƒ§å½•å¹¶åŒæ—¶æ‰“å¼€ä¸²å£ç›‘è§†å™¨ï¼ˆæŸ¥çœ‹è¿è¡Œæ—¥å¿—ï¼‰
idf.py flash monitor

# å¦‚æœåªæƒ³çœ‹æ—¥å¿—ï¼ˆä¸é‡æ–°çƒ§å½•ï¼‰
idf.py monitor
```

> **ä¸²å£ç›‘è§†å™¨å¿«æ·é”®**ï¼šæŒ‰ `Ctrl+]` é€€å‡º monitorã€‚

### å¿«é€Ÿä¸Šæ‰‹ï¼ˆä¸€é”®æ“ä½œï¼‰

å¦‚æœä½ å·²ç»å®‰è£…å¥½ ESP-IDF 5.5.2ï¼Œä»¥ä¸‹å‘½ä»¤å¯ä»¥ä¸€é”®å®Œæˆç¯å¢ƒæ¿€æ´» + ç¼–è¯‘ï¼š

```bash
. ~/.espressif/v5.5.2/esp-idf/export.sh && cd xiaozhi-esp32 && idf.py build
```

## ä¸ MyWeatherStation çš„åŒºåˆ«

| å¯¹æ¯”é¡¹ | MyWeatherStation | xiaozhi-esp32 (æœ¬åˆ†æ”¯) |
|---|---|---|
| æ”¯æŒæ¿å­æ•° | 1 å—ï¼ˆç¡¬ç¼–ç ï¼‰ | å‡ åå—ï¼ˆKconfig é€‰æ‹©ï¼‰ |
| ç¼–è¯‘é…ç½® | ä¸éœ€è¦ï¼Œç›´æ¥ç¼–è¯‘ | éœ€è¦ `menuconfig` é€‰æ¿å­ |
| ESP-IDF ç‰ˆæœ¬ | v5.4 | v5.5.2 |
| æ„å»ºç³»ç»Ÿ | CMakeï¼ˆç®€å•ï¼‰ | CMake + Kconfigï¼ˆå¤æ‚ä½†çµæ´»ï¼‰ |
| UI æ¡†æ¶ | LVGLï¼ˆè‡ªå®šä¹‰å¸ƒå±€ï¼‰ | LVGLï¼ˆç»Ÿä¸€æŠ½è±¡å±‚ + æ¿å­é€‚é…ï¼‰ |
| ç½‘ç»œåŠŸèƒ½ | WiFi + HTTP | WiFi + WebSocket + MQTT + OTA |

## å‚è€ƒèµ„æº

- [å¾®é›ª ESP32-S3-RLCD-4.2 äº§å“é¡µ](https://www.waveshare.net/shop/ESP32-S3-RLCD-4.2.htm)
- [xiaozhi-esp32 é¡¹ç›®](https://github.com/78/xiaozhi-esp32)
- [MyWeatherStation åŸé¡¹ç›®](../../MyWeatherStation)
- [ESP-IDF ç¼–ç¨‹æŒ‡å—](https://docs.espressif.com/projects/esp-idf/zh_CN/v5.5.2/)
- [LVGL æ–‡æ¡£](https://docs.lvgl.io/)
- [Kconfig é…ç½®ç³»ç»Ÿè¯´æ˜](https://docs.espressif.com/projects/esp-idf/zh_CN/v5.5.2/esp32s3/api-reference/kconfig.html)
