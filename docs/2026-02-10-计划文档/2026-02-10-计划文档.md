# ESP32-S3-RLCD-4.2 天气站项目优化计划

**创建时间：** 2026-02-10  
**项目状态：** 核心功能已完成，进入优化阶段  
**当前版本：** v1.0（基础天气站 + AI 助手 + 备忘录）

---

## 📋 待办清单

### 🔥 高优先级（显著提升用户体验）

#### 1. 电源管理优化
**目标：** 提升续航时间 30-50%  
**预计工期：** 2-3 天

- [ ] 实现自动休眠机制
  - [ ] 检测 5 分钟无活动（无按钮按下、无 AI 对话）
  - [ ] 降低屏幕刷新频率（1秒 → 5秒）
  <!-- 搁置不做 -->
  <!-- - [ ] 配置 ESP32-S3 动态调频（DFS）
  - [ ] 在 `waveshare-s3-rlcd-4.2.cc` 中添加 `CheckAutoSleep()` 方法 -->
<!-- - [ ] 充电状态优化
  - [ ] 充电时恢复正常刷新频率
  - [ ] 充电时允许高功耗操作（天气更新、NTP 同步） -->

**技术细节：**
```cpp
// 在 CustomBoard 中添加
class CustomBoard : public WifiBoard {
private:
    bool auto_sleep_enabled_ = true;
    uint32_t last_activity_ms_ = 0;
    const uint32_t AUTO_SLEEP_TIMEOUT_MS = 5 * 60 * 1000;
    
    void CheckAutoSleep();
    void EnterLowPowerMode();
    void ExitLowPowerMode();
};
```

---

#### 2. 备忘录功能增强
**目标：** 让备忘录从"能用"变成"好用"  
**预计工期：** 2-3 天

- [ ] **日期提醒支持**
  - [ ] 支持 `YYYY-MM-DD` 格式日期
  - [ ] 支持自然语言（"明天"、"下周五"、"2月15日"）
  - [ ] 每天 00:00 检查是否有日期到期的备忘
  - [ ] 到期时触发提醒（同时钟提醒）

- [ ] **重复提醒功能**
  - [ ] 支持 `daily`（每天）、`weekly`（每周）、`workday`（工作日）
  - [ ] 触发后不删除，自动计算下次提醒时间
  - [ ] 示例：`{"t":"08:00","c":"吃药","r":"daily"}`

- [ ] **优先级标记**
  - [ ] 添加 `p`（priority）字段：0=普通，1=重要，2=紧急
  - [ ] 显示时用不同前缀：`❗紧急`、`⭐重要`、`·普通`
  - [ ] 紧急备忘用更响亮的提醒音

- [ ] **备忘编辑功能**
  - [ ] 新增 MCP 工具 `self.memo.edit`
  - [ ] 修改指定序号的备忘内容/时间

**JSON 数据格式升级：**
```json
[
  {
    "t": "15:00",           // 时间 HH:MM 或日期 YYYY-MM-DD
    "c": "开会",            // 内容
    "p": 1,                 // 优先级 0/1/2（新增）
    "r": "weekly"           // 重复规则（新增，可选）
  }
]
```

---

#### 3. 传感器历史数据记录
**目标：** 让 AI 能回答"今天温度变化大吗"这类问题  
**预计工期：** 2 天

- [ ] 在 `sensor_manager.cc` 中添加历史记录功能
  - [ ] 每 10 分钟记录一次温湿度
  - [ ] 保存最近 24 小时数据（144 条记录）
  - [ ] 存储到 NVS（key: `sensor_history`）

- [ ] 趋势分析算法
  - [ ] 计算过去 1h/6h/24h 的温湿度变化
  - [ ] 判断趋势：上升/下降/稳定
  - [ ] 生成自然语言描述："温度上升 2°C，湿度下降 10%"

- [ ] 暴露 MCP 工具给 AI
  - [ ] `self.sensor.history` - 查询历史数据
  - [ ] `self.sensor.trend` - 获取趋势分析
  - [ ] `self.sensor.max_min` - 获取今日最高/最低温

**数据结构：**
```cpp
struct HistoryRecord {
    time_t timestamp;      // Unix 时间戳
    float temp;            // 温度
    float humidity;        // 湿度
};
std::vector<HistoryRecord> history_;  // 最多 144 条
```

---

### ⭐ 中优先级（功能增强）

#### 4. 多屏幕模式切换
**目标：** 适配不同使用场景  
**预计工期：** 3-4 天

- [ ] 定义显示模式枚举
  ```cpp
  enum DisplayMode {
      MODE_WEATHER_STATION,  // 当前的 2x2 卡片布局
      MODE_AI_CHAT,          // 全屏 AI 对话（大字体）
      MODE_SENSOR_FOCUS,     // 温度计模式（超大字显示温湿度）
      MODE_MEMO_LIST,        // 全屏待办清单
      MODE_CLOCK             // 极简时钟模式
  };
  ```

- [ ] 实现布局切换逻辑
  - [ ] 长按 BOOT 按钮切换模式
  - [ ] 保存当前模式到 NVS（下次启动恢复）
  - [ ] 切换时播放切换音效

- [ ] 实现各模式 UI
  - [ ] 温度计模式：64px 大字显示温度
  - [ ] AI 对话模式：移除天气卡片，对话区占满屏幕
  - [ ] 待办清单模式：显示完整 10 条备忘

---

#### 5. 网络健壮性优化
**目标：** 减少无效请求，提升体验  
**预计工期：** 1 天

- [x] 天气 API 优化
  - [x] WiFi 未连接时跳过请求
  - [x] 失败后 5 分钟重试（而非等 10 分钟）
  - [x] 缓存上次成功的天气数据（断网也能显示）

- [x] NTP 同步优化
  - [x] 失败后指数退避重试（1s, 2s, 4s, 8s, 16s）
  - [x] 最多重试 5 次后放弃（避免无限循环）
  - [x] 同步成功后每 24 小时自动校准一次

---

#### 6. 番茄钟和定时器功能
**目标：** 增加生产力工具  
**预计工期：** 1-2 天

- [ ] 番茄钟模式（25min 专注 + 5min 休息）
  - [ ] MCP 工具：`self.timer.pomodoro`
  - [ ] 屏幕显示倒计时
  - [ ] 专注结束时播放提示音

- [ ] 自定义定时器
  - [ ] MCP 工具：`self.timer.set` (1-120 分钟)
  - [ ] 到时后播放闹钟音效
  - [ ] 可中途取消

- [ ] 冥想定时器
  - [ ] 每隔一段时间播放轻柔铃声
  - [ ] 适合冥想、瑜伽场景

---

### 💡 低优先级（锦上添花）

#### 7. 开发者调试工具
**预计工期：** 半天

- [ ] 内存使用统计
  - [ ] `self.debug.memory` - 查看 SRAM/PSRAM 使用情况
  
- [ ] 任务状态查询
  - [ ] `self.debug.tasks` - FreeRTOS 任务列表和栈使用

- [ ] 性能监控
  - [ ] `self.debug.cpu` - CPU 使用率
  - [ ] `self.debug.network` - WiFi 信号强度

---

#### 8. UI/UX 细节优化
**预计工期：** 1-2 天

- [ ] 长文本滚动显示
  - [ ] AI 回复超过 50 字时自动滚动
  - [ ] 可配置滚动速度

- [ ] 屏幕对比度调节（如果硬件支持）
  - [ ] 添加 MCP 工具调节 VCOM 电压

- [ ] 状态指示优化
  - [ ] 连接中显示旋转动画（用字符模拟）
  - [ ] 加载中显示进度条

---

#### 9. 电池校准功能
**预计工期：** 半天

- [ ] 暴露电池参数配置
  ```cpp
  struct BatteryConfig {
      float ema_alpha;       // EMA 平滑系数（默认 0.1）
      int sample_count;      // ADC 采样次数（默认 10）
      int voltage_min;       // 最低电压 mV（默认 3300）
      int voltage_max;       // 最高电压 mV（默认 4200）
  };
  ```

- [ ] 添加校准工具
  - [ ] `self.battery.calibrate` - 交互式校准助手
  - [ ] 满电时记录电压，空电时记录电压
  - [ ] 自动生成多项式拟合参数

---

#### 10. 项目文档完善
**预计工期：** 1 天

- [ ] 完善 README.md
  - [ ] 添加硬件购买链接
  - [ ] 添加功能演示 GIF/视频
  - [ ] 添加常见问题 FAQ

- [ ] 编写用户手册
  - [ ] 首次配网步骤
  - [ ] 备忘录使用教程
  - [ ] MCP 工具完整列表

- [ ] 技术文档
  - [ ] RLCD 驱动原理说明
  - [ ] 电池电量算法文档
  - [ ] 多屏幕布局设计思路

---

## 🎯 里程碑规划

### Milestone 1: 省电与可靠性（预计 1 周）
- ✅ 完成电源管理优化
- ✅ 完成网络健壮性优化
- ✅ 完成电池校准功能

**验收标准：**
- 待机续航 > 24 小时
- WiFi 断网重连无 crash
- 电量显示误差 < 5%

---

### Milestone 2: 智能备忘录（预计 1 周）
- ✅ 日期提醒
- ✅ 重复提醒
- ✅ 优先级标记
- ✅ 传感器历史数据

**验收标准：**
- 能提醒"明天下午3点开会"
- 能每天早上8点提醒"吃药"
- AI 能回答"今天温度变化大吗"

---

### Milestone 3: 多模式与工具（预计 2 周）
- ✅ 多屏幕模式切换
- ✅ 番茄钟功能
- ✅ 开发者工具

**验收标准：**
- 可切换 5 种显示模式
- 番茄钟完整工作流程
- 内存/任务监控正常

---

### Milestone 4: 文档与发布（预计 3 天）
- ✅ 完善 README
- ✅ 录制演示视频
- ✅ 发布到 GitHub

**验收标准：**
- 文档清晰完整
- 新用户能按文档成功配置
- 演示视频覆盖所有核心功能

---

## 📊 技术债务记录

### 已知问题
1. **LVGL 内存占用较高**
   - 当前：约 200KB SRAM
   - 优化方向：使用 PSRAM 作为 LVGL 缓冲区

2. **NVS 空间有限**
   - 当前：备忘录最多 10 条
   - 优化方向：使用 SPIFFS/LittleFS 存储更多数据

3. **天气 API 限流**
   - 当前：每 10 分钟请求一次
   - 风险：API 免费额度可能用完
   - 备选方案：使用其他天气 API（如高德地图）

---

## 💡 创意想法池（未来可能实现）

### 硬件扩展
- [ ] 外接 BME680 传感器（检测空气质量）
- [ ] 外接扬声器（更大音量）
- [ ] 外接震动马达（触觉反馈）
- [ ] 3D 打印外壳设计

### 软件功能
- [ ] 集成 Home Assistant（智能家居控制）
- [ ] 桌面宠物模式（emoji 动画互动）
- [ ] 音乐播放器（播放本地 MP3）
- [ ] 简易游戏（贪吃蛇、2048）
- [ ] 股票/加密货币价格监控
- [ ] RSS 订阅阅读器

### 社区功能
- [ ] 配置文件云同步
- [ ] 主题市场（用户自定义 UI 主题）
- [ ] MCP 工具插件市场
- [ ] 多设备联动（多个小智互相通信）

---

## 📝 开发日志

### 2026-02-10
- ✅ 完成核心功能开发
  - 天气站 2x2 卡片布局
  - AI 助手对话显示
  - 备忘录基础功能
  - 温湿度传感器集成
  - RTC 时间同步
  - 电池电量显示

- ✅ 项目代码质量良好
  - DisplayLockGuard 正确使用
  - 硬件资源管理规范
  - 注释详细清晰

- 📋 创建本计划文档
  - 梳理 10 大优化方向
  - 制定 4 个里程碑
  - 记录技术债务

- ✅ 启用 GPIO18 用户按键
  - 单击：显示系统信息（内存、PSRAM、电量、WiFi）
  - 长按：手动刷新所有数据（天气、NTP 时间）
  - 按键功能完全独立于 BOOT 按钮，互不干扰

---

## 🔗 相关资源

### 硬件文档
- [Waveshare ESP32-S3-RLCD-4.2 官方文档](https://www.waveshare.com/wiki/ESP32-S3-RLCD-4.2)
- [ESP32-S3 技术参考手册](https://www.espressif.com/sites/default/files/documentation/esp32-s3_technical_reference_manual_cn.pdf)

### 软件库
- [LVGL 文档](https://docs.lvgl.io/)
- [ESP-IDF 编程指南](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/)
- [小智 ESP32 原项目](https://github.com/78/xiaozhi-esp32)

### API 服务
- [和风天气 API](https://dev.qweather.com/)
- [高德地图 API](https://lbs.amap.com/)

---

## 🎉 已完成功能

- ✅ RLCD 屏幕驱动（1-bit 显示优化）
- ✅ 2x2 卡片布局 UI（时钟/日历/AI/备忘录）
- ✅ SHTC3 温湿度传感器
- ✅ PCF85063 RTC 时钟芯片
- ✅ ES8311 音频输出 + ES7210 音频输入
- ✅ WiFi 配网功能
- ✅ 和风天气 API 集成
- ✅ NTP 时间同步（带 RTC 备份）
- ✅ 电池电量检测（EMA 滤波）
- ✅ MCP 工具系统（备忘录 CRUD）
- ✅ AI 表情显示（21 种表情映射）
- ✅ 备忘闹钟功能（HH:MM 时间匹配）
- ✅ 双按键支持（BOOT + USER GPIO18）
  - BOOT 按钮：AI 对话唤醒/停止、WiFi 配网
  - USER 按钮：系统信息查看、数据手动刷新

---

**备注：**
- 所有待办事项按需调整优先级
- 每完成一项后打钩 ✅
- 遇到问题记录在"开发日志"中
- 本文档持续更新，作为项目开发指南
